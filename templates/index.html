<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PAPER SYSTEM V110</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+KR:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'IBM Plex Sans KR', sans-serif; background-color: #f8fafc; letter-spacing: -0.02em; }
        .glass-card { background: white; border: 1px solid #e2e8f0; border-radius: 1.5rem; }
        .type-card { cursor: pointer; border: 2px solid transparent; transition: all 0.2s; background: white; }
        .type-card.active { border-color: #3b82f6; background-color: #eff6ff; }
        .fav-star.active { color: #facc15 !important; }
        #favorites_bar::-webkit-scrollbar { display: none; }
        canvas { background: white; border-radius: 1rem; width: 100%; height: auto; }
        th.sortable { cursor: pointer; position: relative; }
        th.sortable:hover { background-color: #f1f5f9; }
        th.sortable::after { content: 'â†•'; font-size: 10px; margin-left: 4px; opacity: 0.5; }
    </style>
</head>
<body class="p-3 md:p-8">

    {% if not authenticated %}
    <div class="max-w-md mx-auto mt-20 p-8 glass-card shadow-xl text-center">
        <h2 class="text-xl font-bold mb-6 text-gray-800">ë³´ì•ˆ ì ‘ì†</h2>
        <form method="POST" class="space-y-4">
            <input type="password" name="password" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥" class="w-full px-4 py-3 border rounded-xl text-center focus:border-blue-500 shadow-sm outline-none" autofocus>
            <button type="submit" class="w-full py-3 bg-slate-900 text-white rounded-xl font-bold">ì ‘ì†í•˜ê¸°</button>
        </form>
    </div>
    {% else %}

    <div class="max-w-6xl mx-auto space-y-4">
        <div class="glass-card p-4 shadow-sm grid grid-cols-3 gap-2">
            <div class="type-card active p-3 rounded-xl border text-center" id="btn-soft" onclick="setMode('soft')">
                <p class="text-[10px] text-gray-400 font-bold">ì¸ì¡°ì—†ìŒ</p>
                <p class="font-bold text-xs">í™˜ì–‘ì¥ë¯¸ì†Œ</p>
            </div>
            <div class="type-card p-3 rounded-xl border text-center" id="btn-hard" onclick="setMode('hard')">
                <p class="text-[10px] text-gray-400 font-bold">í™ˆ 11mm</p>
                <p class="font-bold text-xs">ê°ì–‘ì¥</p>
            </div>
            <div class="type-card p-3 rounded-xl border text-center" id="btn-leather" onclick="setMode('leather')">
                <p class="text-[10px] text-gray-400 font-bold">í™ˆ 8mm</p>
                <p class="font-bold text-xs">ì¸ì¡°ìˆìŒ</p>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="space-y-4">
                <div class="p-6 glass-card bg-slate-900 text-white shadow-lg">
                    <div class="flex justify-between items-end mb-4">
                        <span class="text-[10px] font-bold opacity-60 text-blue-300">SPINE (mm)</span>
                        <span id="seneca_result" class="text-4xl font-light font-mono text-blue-400">0.00</span>
                    </div>
                    <div class="space-y-3">
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <label class="text-[10px] text-gray-400 ml-1">ê°€ë¡œ(W)</label>
                                <input type="number" id="bookW" value="148" oninput="calc()" class="w-full p-2 bg-white/10 rounded-lg text-xs border border-white/10 outline-none">
                            </div>
                            <div>
                                <label class="text-[10px] text-gray-400 ml-1">ì„¸ë¡œ(H)</label>
                                <input type="number" id="bookH" value="210" oninput="calc()" class="w-full p-2 bg-white/10 rounded-lg text-xs border border-white/10 outline-none">
                            </div>
                        </div>
                        <div>
                            <label class="text-[10px] text-gray-400 ml-1">í˜ì´ì§€ìˆ˜(P)</label>
                            <input type="number" id="page_input" oninput="calc()" value="200" class="w-full p-3 rounded-xl text-black font-bold outline-none">
                        </div>
                        <div>
                            <label class="text-[10px] text-gray-400 ml-1">í•©ì§€ ì¢…ë¥˜ (qq.xlsx)</label>
                            <select id="board_select" onchange="calc()" class="w-full p-3 bg-white/10 rounded-xl text-xs outline-none">
                                {% for b in boards %}
                                <option value="{{ b.ë‘ê»˜ }}" class="text-slate-900">{{ b.í•©ì§€ëª… }} ({{ b.ë‘ê»˜ }}mm)</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div id="selected_info" class="text-[11px] opacity-70 mt-2">ì„ íƒëœ ì¢…ì´ ì—†ìŒ</div>
                        <div id="fav_price_display" class="text-xl font-bold text-blue-400 font-mono">0ì›</div>
                    </div>
                    <input type="hidden" id="hidden_thick" value="0">
                </div>

                <div class="space-y-3">
                    <form method="POST" class="relative">
                        <input type="text" name="keyword" value="{{ keyword }}" placeholder="ì¢…ì´ ì´ë¦„ ê²€ìƒ‰..." class="w-full p-4 glass-card shadow-md outline-none pr-24">
                        <button type="submit" class="absolute right-2 top-2 bg-blue-600 text-white px-5 py-2 rounded-xl font-bold">ê²€ìƒ‰</button>
                    </form>
                    <div id="favorites_bar" class="flex flex-nowrap gap-2 overflow-x-auto pb-2"></div>
                </div>
            </div>

            <div class="md:col-span-2 space-y-4">
                <div class="glass-card p-4 shadow-sm text-center">
                    <canvas id="mainCanvas" width="800" height="300"></canvas>
                    <div id="final_formula" class="mt-2 p-3 bg-slate-50 rounded-xl text-center font-mono text-[11px] text-slate-500 font-bold">ê·œê²© ê³„ì‚° ì¤‘...</div>
                </div>

                {% if results %}
                <div class="glass-card overflow-hidden shadow-sm">
                    <table class="w-full text-left text-[13px]" id="resultTable">
                        <thead class="bg-slate-50 border-b text-[10px] text-slate-500 font-bold uppercase">
                            <tr>
                                <th class="p-3 text-center">â­</th>
                                <th class="p-3 sortable" onclick="sortTable(1, 'str')">í’ˆëª© / ì •ë³´</th>
                                <th class="p-3 text-center sortable" onclick="sortTable(2, 'num')">í‰ëŸ‰(g)</th>
                                <th class="p-3 text-center">ë‘ê»˜</th>
                                <th class="p-3 text-right">ê³ ì‹œê°€</th>
                                <th class="p-3 text-center">ë§í¬</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y">
                            {% for item in results %}
                            <tr class="hover:bg-blue-50 cursor-pointer" data-id="{{ item.row_id }}" 
                                data-name="{{ item.í’ˆëª© }}" data-thick="{{ item.ë‘ê»˜ }}" data-gram="{{ item.í‰ëŸ‰ }}"
                                data-price="{{ item.ê³ ì‹œê°€ }}" data-color="{{ item.ìƒ‰ìƒ }}" onclick="selectRow(this)">
                                <td class="p-3 text-center">
                                    <button onclick="handleFavorite(event, this)" class="fav-star text-gray-200 text-2xl">â˜…</button>
                                </td>
                                <td class="p-3">
                                    <div class="font-bold text-slate-900">{{ item.í’ˆëª© }}</div>
                                    <div class="text-[10px] text-slate-400">{{ item.ìƒ‰ìƒ }} | {{ item.ì‹œíŠ¸ëª… }}</div>
                                </td>
                                <td class="p-3 text-center font-bold text-slate-600 font-mono">{{ item.í‰ëŸ‰ }}</td>
                                <td class="p-3 text-center font-bold text-blue-600 font-mono">{{ item.ë‘ê»˜ }}Î¼m</td>
                                <td class="p-3 font-bold text-right font-mono">{{ item.ê³ ì‹œê°€ }}</td>
                                <td class="p-3 text-center">
                                    <a href="{{ item.url }}" target="_blank" onclick="event.stopPropagation()" class="inline-block p-2 bg-slate-100 rounded-lg hover:bg-blue-100 text-blue-600">ğŸ”—</a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    {% endif %}

    <script>
        let mode = 'soft';
        let currentSortCol = -1;
        let isAsc = true;

        // --- ì •ë ¬ ê¸°ëŠ¥ ---
        function sortTable(colIdx, type) {
            const tbody = document.querySelector("#resultTable tbody");
            const rows = Array.from(tbody.querySelectorAll("tr"));
            if (currentSortCol === colIdx) isAsc = !isAsc;
            else { isAsc = true; currentSortCol = colIdx; }
            rows.sort((a, b) => {
                let vA = a.cells[colIdx].innerText.replace(/,/g, '').trim();
                let vB = b.cells[colIdx].innerText.replace(/,/g, '').trim();
                return type === 'num' ? (isAsc ? vA - vB : vB - vA) : (isAsc ? vA.localeCompare(vB) : vB.localeCompare(vA));
            });
            rows.forEach(r => tbody.appendChild(r));
        }

        function setMode(m) {
            mode = m;
            document.querySelectorAll('.type-card').forEach(el => el.classList.remove('active'));
            document.getElementById('btn-' + m).classList.add('active');
            calc();
        }

        function selectRow(el) {
            const d = el.dataset;
            document.getElementById('hidden_thick').value = d.thick;
            document.getElementById('selected_info').innerText = `${d.name} ${d.color} (${d.gram}g)`;
            document.getElementById('fav_price_display').innerText = `${d.price}ì›`;
            calc();
        }

        function handleFavorite(e, btn) {
            e.stopPropagation();
            const d = btn.closest('tr').dataset;
            let favs = JSON.parse(localStorage.getItem('paper_favs') || '[]');
            const idx = favs.findIndex(f => f.id === d.id);
            if (idx > -1) favs.splice(idx, 1);
            else favs.push({ id: d.id, name: d.name, thick: d.thick, gram: d.gram, price: d.price, color: d.color });
            localStorage.setItem('paper_favs', JSON.stringify(favs));
            renderFavorites();
        }

        function renderFavorites() {
            const bar = document.getElementById('favorites_bar');
            if(!bar) return;
            const favs = JSON.parse(localStorage.getItem('paper_favs') || '[]');
            document.querySelectorAll('tr[data-id]').forEach(tr => {
                const star = tr.querySelector('.fav-star');
                if(favs.some(f => f.id === tr.dataset.id)) star.classList.add('active');
                else star.classList.remove('active');
            });
            bar.innerHTML = favs.map(f => `
                <div onclick="quickDisplay('${f.thick}', '${f.name}', '${f.gram}', '${f.price}', '${f.color}')" class="flex-shrink-0 flex items-center gap-2 px-4 py-2 bg-white border rounded-full shadow-sm cursor-pointer hover:border-blue-300">
                    <span class="text-yellow-400 text-xs">â˜…</span><span class="text-[11px] font-bold text-slate-700 whitespace-nowrap">${f.name}</span>
                </div>
            `).join('');
        }

        function quickDisplay(thick, name, gram, price, color) {
            document.getElementById('hidden_thick').value = thick;
            document.getElementById('selected_info').innerText = `${name} (${gram}g)`;
            document.getElementById('fav_price_display').innerText = `${price}ì›`;
            calc();
        }

        function calc() {
            const w = parseFloat(document.getElementById('bookW').value) || 0;
            const h = parseFloat(document.getElementById('bookH').value) || 0;
            const pg = parseInt(document.getElementById('page_input').value) || 0;
            const t = parseFloat(document.getElementById('hidden_thick').value) || 0;
            const bMm = parseFloat(document.getElementById('board_select').value) || 0;

            const b15 = (t * pg) / 2 / 1000;
            let spine = 0, joint = 0, error = "";

            if (mode === 'soft') { spine = Math.ceil(b15 + (bMm * 2) + 4); joint = 0; }
            else if (mode === 'hard') { spine = Math.ceil(b15 + bMm); joint = 11; }
            else if (mode === 'leather') {
                joint = 8;
                if (b15 >= 40) error = "ì œì‘ë¶ˆê°€";
                else if (b15 >= 35) spine = b15 + 9;
                else if (b15 >= 25) spine = b15 + 8;
                else if (b15 >= 15) spine = b15 + 7;
                else if (b15 >= 10) spine = b15 + 6;
                else if (b15 >= 1)  spine = b15 + 5;
                else spine = b15;
                spine = Math.ceil(spine);
            }

            const boardW = w - 4;
            const bleed = 17;
            const totalW = bleed + boardW + (joint * 2) + spine + boardW + bleed;
            const totalH = bleed + h + bleed;

            document.getElementById('seneca_result').innerText = error ? "ERR" : spine;
            document.getElementById('final_formula').innerText = error || `ê·œê²©: ${totalW} x ${totalH}mm (${bleed}+${boardW}+${joint}+${spine}+${joint}+${boardW}+${bleed})`;
            draw(bleed, boardW, joint, spine, h);
        }

        function draw(bleed, board, joint, spine, h_val) {
            const cvs = document.getElementById('mainCanvas'), ctx = cvs.getContext('2d');
            ctx.clearRect(0, 0, cvs.width, cvs.height);
            const totalW = bleed*2 + board*2 + (joint*2) + spine;
            const scale = 700 / totalW;
            const drawH = Math.min(120 * (h_val / 210), 160);
            const bleedH = bleed * scale; 
            const y_start = (cvs.height - (drawH + bleedH * 2)) / 2 + 10;
            let x = 50;

            const box = (w, label, color, isBleed = false) => {
                if (w <= 0 && label === "í™ˆ") return;
                const cw = w * scale;
                ctx.fillStyle = "#fee2e2"; ctx.fillRect(x, y_start, cw, bleedH); // ìƒë‹¨ì—¬ë¶„
                ctx.fillStyle = isBleed ? "#fee2e2" : color; ctx.fillRect(x, y_start + bleedH, cw, drawH); // ë³¸ì²´
                ctx.fillStyle = "#fee2e2"; ctx.fillRect(x, y_start + bleedH + drawH, cw, bleedH); // í•˜ë‹¨ì—¬ë¶„
                ctx.strokeStyle = "#cbd5e1"; ctx.strokeRect(x, y_start, cw, bleedH + drawH + bleedH);
                ctx.fillStyle = "#64748b"; ctx.font = "bold 9px Arial"; ctx.fillText(label, x + 2, y_start - 10);
                ctx.fillStyle = "#334155"; ctx.fillText(Math.round(w), x + (cw / 2) - 5, y_start + bleedH + drawH / 2 + 5);
                if (x + cw > 680 && !isBleed) { ctx.fillStyle = "#94a3b8"; ctx.fillText(`H:${h_val}+${bleed*2}`, x + cw + 10, y_start + bleedH + drawH/2); }
                x += cw;
            };

            box(bleed, "ì—¬ë¶„", "#fee2e2", true); box(board, "ë³´ë“œ", "#f1f5f9");
            if(joint) box(joint, "í™ˆ", "#f8fafc"); box(spine, "ì„¸ë„¤ì¹´", "#ffffff");
            if(joint) box(joint, "í™ˆ", "#f8fafc"); box(board, "ë³´ë“œ", "#f1f5f9"); 
            box(bleed, "ì—¬ë¶„", "#fee2e2", true);
        }
        window.onload = () => { renderFavorites(); calc(); };
    </script>
</body>
</html>