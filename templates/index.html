<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PAPER PRO V130</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+KR:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'IBM Plex Sans KR', sans-serif; background-color: #f1f5f9; }
        .glass-card { background: white; border-radius: 1rem; border: 1px solid #e2e8f0; }
        .mode-btn { cursor: pointer; transition: all 0.2s; border: 2px solid #e2e8f0; border-radius: 12px; background: white; padding: 15px; text-align: center; color: #64748b; }
        .mode-btn.active { border-color: #3b82f6; background-color: #3b82f6; color: white; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3); }
        .mode-btn.active p { color: rgba(255, 255, 255, 0.8); }
        .fav-star.active { color: #facc15 !important; }
        th.sortable { cursor: pointer; position: relative; }
        th.sortable::after { content: 'â†•'; font-size: 10px; margin-left: 5px; opacity: 0.3; }
    </style>
</head>
<body class="p-3 md:p-6">

    {% if not authenticated %}
    <div class="max-w-md mx-auto mt-20 p-8 glass-card shadow-xl text-center">
        <h2 class="text-xl font-bold mb-6">ë³´ì•ˆ ì ‘ì†</h2>
        <form method="POST" class="space-y-4">
            <input type="password" name="password" placeholder="ë¹„ë°€ë²ˆí˜¸" class="w-full p-4 border rounded-xl text-center outline-none focus:border-blue-500" autofocus>
            <button type="submit" class="w-full py-4 bg-blue-600 text-white rounded-xl font-bold">ì‹œìŠ¤í…œ ì ‘ì†</button>
        </form>
    </div>
    {% else %}

    <div class="max-w-6xl mx-auto space-y-4">
        <div class="grid grid-cols-3 gap-3">
            <div class="mode-btn active" id="btn-soft" onclick="setMode('soft')">
                <p class="text-[11px] font-bold mb-1">ì¸ì¡°ì—†ìŒ</p><p class="font-bold text-sm md:text-base">í™˜ì–‘ì¥ë¯¸ì†Œ</p>
            </div>
            <div class="mode-btn" id="btn-hard" onclick="setMode('hard')">
                <p class="text-[11px] font-bold mb-1">í™ˆ 11mm</p><p class="font-bold text-sm md:text-base">ê°ì–‘ì¥</p>
            </div>
            <div class="mode-btn" id="btn-leather" onclick="setMode('leather')">
                <p class="text-[11px] font-bold mb-1">í™ˆ 8mm</p><p class="font-bold text-sm md:text-base">ì¸ì¡°ìˆìŒ</p>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="space-y-4">
                <div class="p-6 glass-card bg-slate-900 text-white shadow-lg">
                    <div class="flex justify-between items-end mb-6">
                        <span class="text-xs font-bold text-blue-300">SPINE (mm)</span>
                        <span id="seneca_result" class="text-5xl font-light font-mono text-blue-400">0.00</span>
                    </div>
                    <div class="space-y-4">
                        <div class="grid grid-cols-2 gap-3">
                            <div><label class="text-[11px] text-gray-400">ê°€ë¡œ(W)</label><input type="number" id="bookW" value="148" oninput="calc()" class="w-full p-3 bg-white/10 rounded-xl text-sm outline-none"></div>
                            <div><label class="text-[11px] text-gray-400">ì„¸ë¡œ(H)</label><input type="number" id="bookH" value="210" oninput="calc()" class="w-full p-3 bg-white/10 rounded-xl text-sm outline-none"></div>
                        </div>
                        <div><label class="text-[11px] text-gray-400">í˜ì´ì§€ìˆ˜(P)</label><input type="number" id="page_input" value="200" oninput="calc()" class="w-full p-4 rounded-xl text-black font-bold outline-none text-lg"></div>
                        <div>
                            <label class="text-[11px] text-gray-400">í•©ì§€ ì„ íƒ</label>
                            <select id="board_select" onchange="calc()" class="w-full p-3 bg-white/10 rounded-xl text-sm outline-none">
                                {% for b in boards %}
                                <option value="{{ b.ë‘ê»˜ }}" class="text-slate-900">{{ b.í•©ì§€ëª… }} ({{ b.ë‘ê»˜ }}mm)</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div id="selected_info" class="text-xs opacity-60">ì¢…ì´ ë¯¸ì„ íƒ</div>
                        <div id="fav_price_display" class="text-2xl font-bold text-blue-400 font-mono">0ì›</div>
                        <input type="hidden" id="hidden_thick" value="0">
                    </div>
                </div>

                <div class="space-y-3">
                    <form method="POST" class="relative">
                        <input type="text" name="keyword" value="{{ keyword }}" placeholder="ì¢…ì´ ì´ë¦„/ìƒ‰ìƒ ê²€ìƒ‰..." class="w-full p-4 glass-card shadow-sm outline-none pr-24 border-2 focus:border-blue-500">
                        <button type="submit" class="absolute right-2 top-2 bg-blue-600 text-white px-5 py-2 rounded-xl font-bold">ê²€ìƒ‰</button>
                    </form>
                    <div id="favorites_bar" class="flex flex-nowrap gap-2 overflow-x-auto pb-2"></div>
                </div>
            </div>

            <div class="md:col-span-2 space-y-4">
                <div class="glass-card p-4 shadow-sm text-center bg-white">
                    <canvas id="mainCanvas" width="800" height="300"></canvas>
                    <div id="final_formula" class="mt-3 p-3 bg-slate-50 rounded-xl font-mono text-xs text-slate-500 font-bold italic">ê²°ê³¼ ëŒ€ê¸° ì¤‘...</div>
                </div>

                {% if results %}
                <div class="glass-card overflow-hidden shadow-sm">
                    <table class="w-full text-left text-sm" id="resultTable">
                        <thead class="bg-slate-50 border-b text-[11px] text-slate-500 font-bold uppercase">
                            <tr>
                                <th class="p-4 text-center">â­</th>
                                <th class="p-4 sortable" onclick="sortTable(1, 'str')">í’ˆëª© / ì •ë³´</th>
                                <th class="p-4 text-center sortable" onclick="sortTable(2, 'num')">í‰ëŸ‰(g)</th>
                                <th class="p-4 text-center">ë‘ê»˜</th>
                                <th class="p-4 text-right">ê³ ì‹œê°€</th>
                                <th class="p-4 text-center">ë§í¬</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y">
                            {% for item in results %}
                            <tr class="hover:bg-blue-50 cursor-pointer" 
                                data-id="{{ item.row_id }}" 
                                data-name="{{ item.í’ˆëª© }}" 
                                data-thick="{{ item.ë‘ê»˜ }}" 
                                data-gram="{{ item.í‰ëŸ‰ }}" 
                                data-price="{{ item.ê³ ì‹œê°€ }}" 
                                data-color="{{ item.ìƒ‰ìƒ }}" 
                                onclick="selectRow(this)">
                                <td class="p-4 text-center"><button onclick="handleFavorite(event, this)" class="fav-star text-gray-200 text-2xl">â˜…</button></td>
                                <td class="p-4">
                                    <div class="font-bold text-slate-900">{{ item.í’ˆëª© }}</div>
                                    <div class="text-[11px] text-slate-400">{{ item.ìƒ‰ìƒ }} | {{ item.ì‹œíŠ¸ëª… }}</div>
                                </td>
                                <td class="p-4 text-center font-bold text-slate-600 font-mono">{{ item.í‰ëŸ‰ }}</td>
                                <td class="p-4 text-center font-bold text-blue-600 font-mono">{{ item.ë‘ê»˜ }}Î¼m</td>
                                <td class="p-4 font-bold text-right font-mono">{{ item.ê³ ì‹œê°€ }}</td>
                                <td class="p-4 text-center"><a href="{{ item.url }}" target="_blank" onclick="event.stopPropagation()" class="p-2 bg-slate-100 rounded-lg text-blue-600">ğŸ”—</a></td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    {% endif %}

    <script>
        let mode = 'soft';
        let currentSortCol = -1;
        let isAsc = true;

        function setMode(m) {
            mode = m;
            document.querySelectorAll('.mode-btn').forEach(el => el.classList.remove('active'));
            document.getElementById('btn-' + m).classList.add('active');
            calc();
        }

        // ì¢…ì´ ì„ íƒ ì‹œ ë°ì´í„°ë¥¼ hidden inputì— ë„£ê³  ì¦‰ì‹œ ê³„ì‚° í˜¸ì¶œ
        function selectRow(el) {
            const d = el.dataset;
            document.getElementById('hidden_thick').value = d.thick;
            document.getElementById('selected_info').innerText = `${d.name} ${d.color} (${d.gram}g)`;
            document.getElementById('fav_price_display').innerText = `${d.price}ì›`;
            calc(); // ì¦‰ì‹œ ê³„ì‚° ì‹¤í–‰
        }

        function calc() {
            const w = parseFloat(document.getElementById('bookW').value) || 0;
            const h = parseFloat(document.getElementById('bookH').value) || 0;
            const pg = parseInt(document.getElementById('page_input').value) || 0;
            const t_um = parseFloat(document.getElementById('hidden_thick').value) || 0; // Î¼m ë‹¨ìœ„
            const bMm = parseFloat(document.getElementById('board_select').value) || 0;

            // í•µì‹¬ ê³µì‹: (ë‘ê»˜ * í˜ì´ì§€) / 2 / 1000 = ë³¸ë¬¸ mm ë‘ê»˜
            const textThick = (t_um * pg) / 2 / 1000;
            
            let spine = 0, joint = 0, error = "";

            if (mode === 'soft') {
                spine = Math.ceil(textThick + (bMm * 2) + 4);
                joint = 0;
            } else if (mode === 'hard') {
                spine = Math.ceil(textThick + bMm);
                joint = 11;
            } else if (mode === 'leather') {
                joint = 8;
                if (textThick >= 40) error = "ì œì‘ë¶ˆê°€";
                else if (textThick >= 35) spine = textThick + 9;
                else if (textThick >= 25) spine = textThick + 8;
                else if (textThick >= 15) spine = textThick + 7;
                else if (textThick >= 10) spine = textThick + 6;
                else if (textThick >= 1)  spine = textThick + 5;
                else spine = textThick;
                spine = Math.ceil(spine);
            }

            const boardW = w - 4;
            const bleed = 17;
            const totalW = bleed + boardW + (joint * 2) + spine + boardW + bleed;
            const totalH = bleed + h + bleed;

            document.getElementById('seneca_result').innerText = error ? "ERR" : (spine > 0 ? spine : "0.00");
            document.getElementById('final_formula').innerText = error || `ê·œê²©: ${totalW} x ${totalH}mm (${bleed}+${boardW}+${joint}+${spine}+${joint}+${boardW}+${bleed})`;
            
            draw(bleed, boardW, joint, spine, h);
        }

        function draw(bleed, board, joint, spine, h_val) {
            const cvs = document.getElementById('mainCanvas'), ctx = cvs.getContext('2d');
            ctx.clearRect(0, 0, cvs.width, cvs.height);
            
            const totalW_val = bleed*2 + board*2 + (joint*2) + (spine || 0);
            const scale = 700 / Math.max(totalW_val, 300);
            const drawH = Math.min(120 * (h_val / 210), 160);
            const bleedH = bleed * scale; 
            const y_start = (cvs.height - (drawH + bleedH * 2)) / 2 + 10;
            let startX = (cvs.width - (totalW_val * scale)) / 2;

            const box = (w, label, color, isBleed = false) => {
                if (w <= 0 && label === "í™ˆ") return;
                const cw = w * scale;
                // ìƒë‹¨ ì—¬ë¶„
                ctx.fillStyle = "#fee2e2"; ctx.fillRect(startX, y_start, cw, bleedH);
                // ë³¸ì²´
                ctx.fillStyle = isBleed ? "#fee2e2" : color; ctx.fillRect(startX, y_start + bleedH, cw, drawH);
                // í•˜ë‹¨ ì—¬ë¶„
                ctx.fillStyle = "#fee2e2"; ctx.fillRect(startX, y_start + bleedH + drawH, cw, bleedH);
                
                ctx.strokeStyle = "#cbd5e1"; ctx.strokeRect(startX, y_start, cw, bleedH + drawH + bleedH);
                
                ctx.fillStyle = "#334155"; ctx.font = "bold 9px Arial";
                ctx.fillText(label, startX + 2, y_start - 8);
                ctx.fillText(Math.round(w), startX + (cw / 2) - 5, y_start + bleedH + drawH / 2 + 5);
                startX += cw;
            };

            box(bleed, "ì—¬ë¶„", "#fee2e2", true);
            box(board, "ë³´ë“œ", "#f1f5f9");
            if(joint > 0) box(joint, "í™ˆ", "#f8fafc");
            box(spine || 0, "ì„¸ë„¤ì¹´", "#ffffff");
            if(joint > 0) box(joint, "í™ˆ", "#f8fafc");
            box(board, "ë³´ë“œ", "#f1f5f9"); 
            box(bleed, "ì—¬ë¶„", "#fee2e2", true);
        }

        function sortTable(colIdx, type) {
            const tbody = document.querySelector("#resultTable tbody");
            const rows = Array.from(tbody.querySelectorAll("tr"));
            if (currentSortCol === colIdx) isAsc = !isAsc; else { isAsc = true; currentSortCol = colIdx; }
            rows.sort((a, b) => {
                let vA = a.cells[colIdx].innerText.replace(/,/g, '').trim();
                let vB = b.cells[colIdx].innerText.replace(/,/g, '').trim();
                return type === 'num' ? parseFloat(vA) - parseFloat(vB) * (isAsc ? 1 : -1) : vA.localeCompare(vB) * (isAsc ? 1 : -1);
            });
            if (!isAsc) rows.reverse();
            rows.forEach(r => tbody.appendChild(r));
        }

        function handleFavorite(e, btn) {
            e.stopPropagation();
            const d = btn.closest('tr').dataset;
            let favs = JSON.parse(localStorage.getItem('paper_favs') || '[]');
            const idx = favs.findIndex(f => f.id === d.id);
            if (idx > -1) favs.splice(idx, 1);
            else favs.push({ id: d.id, name: d.name, thick: d.thick, gram: d.gram, price: d.price, color: d.color });
            localStorage.setItem('paper_favs', JSON.stringify(favs));
            renderFavorites();
        }

        function renderFavorites() {
            const bar = document.getElementById('favorites_bar');
            if(!bar) return;
            const favs = JSON.parse(localStorage.getItem('paper_favs') || '[]');
            document.querySelectorAll('tr[data-id]').forEach(tr => {
                const star = tr.querySelector('.fav-star');
                if(favs.some(f => f.id === tr.dataset.id)) star.classList.add('active');
                else star.classList.remove('active');
            });
            bar.innerHTML = favs.map(f => `
                <div onclick="quickDisplay('${f.thick}', '${f.name}', '${f.gram}', '${f.price}', '${f.color}')" class="flex-shrink-0 flex items-center gap-2 px-4 py-2 bg-white border-2 rounded-full shadow-sm cursor-pointer hover:border-blue-300">
                    <span class="text-yellow-400 text-xs">â˜…</span><span class="text-[11px] font-bold text-slate-700 whitespace-nowrap">${f.name}</span>
                </div>
            `).join('');
        }

        function quickDisplay(thick, name, gram, price, color) {
            document.getElementById('hidden_thick').value = thick;
            document.getElementById('selected_info').innerText = `${name} (${gram}g)`;
            document.getElementById('fav_price_display').innerText = `${price}ì›`;
            calc();
        }

        window.onload = () => { renderFavorites(); calc(); };
    </script>
</body>
</html>