<script>
    let mode = 'soft';
    window.onload = () => { renderFavorites(); calc(); };

    // ... 중략 (setMode, selectRow, handleFavorite 등 기존 기능 유지) ...

    function calc() {
        const w = parseFloat(document.getElementById('bookW').value) || 0;
        const h = parseFloat(document.getElementById('bookH').value) || 0;
        const pg = parseInt(document.getElementById('page_input').value) || 0;
        const t = parseFloat(document.getElementById('hidden_thick').value) || 0;
        const bMm = parseFloat(document.getElementById('board_select').value) || 0;

        const b15 = (t * pg) / 2 / 1000;
        let spine = 0, joint = 0, error = "";

        if (mode === 'soft') { spine = Math.ceil(b15 + (bMm * 2) + 4); joint = 0; }
        else if (mode === 'hard') { spine = Math.ceil(b15 + bMm); joint = 11; }
        else if (mode === 'leather') {
            joint = 8;
            if (b15 >= 40) error = "제작불가";
            else if (b15 >= 35) spine = b15 + 9;
            else if (b15 >= 25) spine = b15 + 8;
            else if (b15 >= 15) spine = b15 + 7;
            else if (b15 >= 10) spine = b15 + 6;
            else if (b15 >= 1)  spine = b15 + 5;
            else spine = b15;
            spine = Math.ceil(spine);
        }

        const boardW = w - 4;
        const bleed = 17;
        const totalW = bleed + boardW + (joint * 2) + spine + boardW + bleed;

        document.getElementById('seneca_result').innerText = error ? "ERR" : spine;
        document.getElementById('final_formula').innerText = error || `${bleed} + ${boardW} + ${joint} + ${spine} + ${joint} + ${boardW} + ${bleed} = ${totalW}mm`;
        
        // 도면 그리기 함수 호출 시 세로(h) 값 전달
        draw(bleed, boardW, joint, spine, h);
    }

    function draw(bleed, board, joint, spine, h_val) {
        const cvs = document.getElementById('mainCanvas'), ctx = cvs.getContext('2d');
        ctx.clearRect(0, 0, cvs.width, cvs.height);
        
        const totalW = bleed*2 + board*2 + (joint*2) + spine;
        const scale = 700 / totalW;
        
        // 세로 높이 시각화 로직: 입력된 세로(h_val)에 따라 높이가 변함
        const baseH = 100;
        const drawH = Math.min(baseH * (h_val / 210), 160); // 210mm(A5급) 기준 비례 조절
        const y_start = (cvs.height - drawH) / 2 + 10;
        const x_start = 50;
        let x = x_start;

        const box = (w, label, color, isBleed = false) => {
            if (w <= 0 && label === "홈") return;
            
            ctx.fillStyle = color;
            // 여분(Bleed)은 상하로 더 튀어나온 느낌 표현
            const currentH = isBleed ? drawH + 10 : drawH;
            const currentY = isBleed ? y_start - 5 : y_start;
            
            ctx.fillRect(x, currentY, w * scale, currentH);
            ctx.strokeStyle = "#cbd5e1";
            ctx.lineWidth = 1;
            ctx.strokeRect(x, currentY, w * scale, currentH);
            
            // 라벨 표시 (여분은 위, 나머지는 박스 안)
            ctx.fillStyle = "#64748b";
            ctx.font = "bold 9px Arial";
            ctx.fillText(label, x + 2, currentY - 10);
            
            // 수치 표시
            ctx.fillStyle = "#334155";
            ctx.font = "bold 10px font-mono";
            ctx.fillText(Math.round(w), x + (w * scale / 2) - 6, currentY + currentH / 2 + 5);

            // 마지막 박스 옆에 세로 수치 표시
            if (x + w * scale > 700 && !isBleed) {
                ctx.fillStyle = "#94a3b8";
                ctx.fillText(`H: ${h_val}`, x + w * scale + 10, y_start + drawH / 2);
            }
            
            x += w * scale;
        };

        box(bleed, "여분", "#fee2e2", true); 
        box(board, "보드", "#f1f5f9");
        if(joint) box(joint, "홈", "#f8fafc");
        box(spine, "세네카", "#ffffff");
        if(joint) box(joint, "홈", "#f8fafc");
        box(board, "보드", "#f1f5f9"); 
        box(bleed, "여분", "#fee2e2", true);
    }
</script>